@using System.Security.Claims
@using Luftfartshinder.Models.Domain
@using Microsoft.AspNetCore.Identity
@model Luftfartshinder.Models.ViewModel.Organization.OrgDataViewModel

@inject UserManager<ApplicationUser> userManager

@{
    var userId = userManager.GetUserId(User);
}

@section Styles {
    <link href="~/css/registrar.css" rel="stylesheet" />
}

<div class="container mt-5 py-5">
    <header class="h1 text-center">
        Your Obstacles & Reports
    </header>

    <subheader class="display-6">
        Obstacles:
    </subheader>
    <table class="table table-hover mb-5">
        <thead>
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Type</th>
                <th scope="col">Name</th>
                <th scope="col">Height</th>
                <th scope="col">Lat</th>
                <th scope="col">Lon</th>
                <th scope="col">Registrar Note</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody class="table-group-divider">
            @foreach (var r in Model.Reports)
            {
                if(r.AuthorId == userId)
                {
                    foreach (var o in r.Obstacles)
                    {
                        <tr>
                            <th scope="row">@o.Id</th>
                            <td>@o.Type</td>
                            <td>@o.Name</td>
                            <td>@o.Height</td>

                            @{
                                string formattedLatitude = String.Format("{0:0.000000}", o.Latitude);
                                string formattedLongitude = String.Format("{0:0.000000}", o.Longitude);
                            }

                            <td>@formattedLatitude</td>
                            <td>@formattedLongitude</td>
                            <td>@o.RegistrarNote</td>
                            <td>
                                @switch (o.Status)
                                {
                                    case Luftfartshinder.Models.Domain.Obstacle.Statuses.Approved:
                                        <span class="pill pill-approved">Approved</span>
                                        break;
                                    case Luftfartshinder.Models.Domain.Obstacle.Statuses.Rejected:
                                        <span class="pill pill-rejected">Rejected</span>
                                        break;
                                    case Luftfartshinder.Models.Domain.Obstacle.Statuses.Pending:
                                        <span class="pill pill-pending">Pending</span>
                                        break;
                                }
                            </td>
                            <td>
                                <a asp-action="ObstacleDetails" asp-controller="FlightCrew" asp-route-id="@o.Id" 
                                   class="btn btn-primary">
                                    View
                                </a>
                            </td>
                        </tr>
                        
                    }
                    
                }
            }
        </tbody>
    </table>

    <subheader class="display-6">
        Reports:
    </subheader>
    <table class="table table-hover">
        <thead>
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Title</th>
                <th scope="col">Date</th>
                <th scope="col">No. of Obstacles</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody class="table-group-divider">
            @foreach (var r in Model.Reports)
            {
                if (r.AuthorId == User.FindFirstValue(ClaimTypes.NameIdentifier))
                {
                    <tr>
                        <th scope="row">@r.Id</th>
                        <td>@r.Title</td>
                        <td>@r.ReportDate</td>
                        <td>@r.Obstacles.Count</td>
                        <td>
                            <a asp-action="ReportDetails" asp-controller="FlightCrew" asp-route-id="@r.Id" 
                               class="btn btn-primary">
                                View
                            </a>
                        </td>
                    </tr>
                    
                }
            }
        </tbody>
    </table>

    <subheader class="display-6">
        @Model.Organization.Name Obstacles:
    </subheader>
    <table class="table table-hover mb-5">
        <thead>
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Type</th>
                <th scope="col">Name</th>
                <th scope="col">Height</th>
                <th scope="col">Lat</th>
                <th scope="col">Lon</th>
                <th scope="col">Registrar Note</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody class="table-group-divider">
            @foreach (var o in Model.Obstacles)
            {
                <tr>
                    <th scope="row">@o.Id</th>
                    <td>@o.Type</td>
                    <td>@o.Name</td>
                    <td>@o.Height</td>

                    @{
                        string formattedLatitude = String.Format("{0:0.000000}", o.Latitude);
                        string formattedLongitude = String.Format("{0:0.000000}", o.Longitude);
                    }

                    <td>@formattedLatitude</td>
                    <td>@formattedLongitude</td>
                    <td>@o.RegistrarNote</td>
                    <td>
                        @switch (o.Status)
                        {
                            case Luftfartshinder.Models.Domain.Obstacle.Statuses.Approved:
                                <span class="pill pill-approved">Approved</span>
                                break;
                            case Luftfartshinder.Models.Domain.Obstacle.Statuses.Rejected:
                                <span class="pill pill-rejected">Rejected</span>
                                break;
                            case Luftfartshinder.Models.Domain.Obstacle.Statuses.Pending:
                                <span class="pill pill-pending">Pending</span>
                                break;
                        }
                    </td>
                    <td>
                        <a asp-action="ObstacleDetails" asp-controller="FlightCrew" asp-route-id="@o.Id" 
                           class="btn btn-primary">
                            View
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>