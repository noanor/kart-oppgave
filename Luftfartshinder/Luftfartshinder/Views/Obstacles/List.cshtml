@model List<Luftfartshinder.Models.Domain.Obstacle>

@* 
    Registrar - Obstacle List View
    --------------------------------------------------
    This page shows all obstacles that have been reported.
    The registrar can search, sort, and open an obstacle to edit it.
*@

@section Styles {
    @* Page specific styling for the obstacle list *@
    <link href="~/css/registrar.css" rel="stylesheet" />
}

<div class="container mt-5 py-5">
    @* Page title *@
    <div class="h1 text-center">
        List of Obstacles
    </div>

    @* Simple client-side search field (filters table rows below) *@
    <div class="mb-3">
        <input id="obstacleSearch" class="form-control" placeholder="Search obstacles..." />
    </div>

    @* Main obstacle table with sortable columns *@
    <table id="obstacleTable" class="table table-hover mb-5">
        <thead>
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Reporter</th>
                <th scope="col">Type</th>
                <th scope="col">Name</th>
                <th scope="col">Height</th>
                <th scope="col">Lat</th>
                <th scope="col">Lon</th>
                <th scope="col">Registrar Note</th>
                <th scope="col">Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody class="table-group-divider">
            @if (Model != null && Model.Count > 0)
            {
                @* Render one table row per obstacle in the model *@
                @foreach (var o in Model)
                {
                    <tr>
                        <th scope="row">@o.Id</th>
                        <td>@(o.Report?.Author ?? "N/A")</td>
                        <td>@o.Type</td>
                        <td>@o.Name</td>
                        <td>@o.Height</td>

                        @* Format coordinates to 6 decimal places for a consistent look *@
                        @{
                            string formattedLatitude = String.Format("{0:0.000000}", o.Latitude);
                            string formattedLongitude = String.Format("{0:0.000000}", o.Longitude);
                        }

                        <td>@formattedLatitude</td>
                        <td>@formattedLongitude</td>
                        <td>@o.RegistrarNote</td>

                        <td>
                            @* Status pill with color depending on the obstacle status *@
                            @switch (o.Status)
                            {
                                case Luftfartshinder.Models.Domain.Obstacle.Statuses.Approved:
                                    <span class="pill pill-approved">Approved</span>
                                    break;

                                case Luftfartshinder.Models.Domain.Obstacle.Statuses.Rejected:
                                    <span class="pill pill-rejected">Rejected</span>
                                    break;

                                case Luftfartshinder.Models.Domain.Obstacle.Statuses.Pending:
                                    <span class="pill pill-pending">Pending</span>
                                    break;
                            }
                        </td>

                        <td>
                            @* Link to open the obstacle in the Edit view *@
                            <a class="btn btn-outline-primary shadow" role="button"
                               asp-action="Edit"
                               asp-controller="Obstacles"
                               asp-route-id="@o.Id">
                                Edit
                                <span class="material-symbols-outlined inline-icon">
                                    edit
                                </span>
                            </a>
                        </td>
                    </tr>
                }
            }
            else
            {
                @* Fallback row when there are no obstacles in the model *@
                <tr>
                    <td colspan="10" class="text-center text-muted py-4">
                        No obstacles found. Obstacles will appear here after they have been submitted from the draft.
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        // Simple client-side search that hides rows that do not match the search term
        const searchInput = document.getElementById('obstacleSearch');
        const table = document.getElementById('obstacleTable');
        const rows = table.querySelectorAll('tbody tr');

        searchInput.addEventListener('input', function () {
            const term = this.value.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        });

        // Self-invoking function that adds click-to-sort behavior to table headers
        (function () {
            const table = document.getElementById('obstacleTable');
            if (!table) return;

            const headers = table.querySelectorAll('thead th');
            const numericCols = [0, 3, 4, 5]; // Id, Height, Lat, Lon

            // Store original header text once
            headers.forEach((th, index) => {
                th.dataset.label = th.textContent.trim(); // save clean label
                th.style.cursor = 'pointer';

                th.addEventListener('click', () => {
                    const tbody = table.tBodies[0];
                    const rows = Array.from(tbody.querySelectorAll('tr'));

                    // Determine sort direction for this header
                    const isAsc = th.dataset.sort === 'asc';
                    const newDir = isAsc ? 'desc' : 'asc';

                    // Reset all headers: remove sort + restore original label
                    headers.forEach(h => {
                        h.removeAttribute('data-sort');
                        h.innerHTML = h.dataset.label;
                    });

                    // Set active header state and show arrow in the header cell
                    th.dataset.sort = newDir;
                    const arrow = newDir === 'asc' ? ' ▲' : ' ▼';
                    th.innerHTML = th.dataset.label + arrow;

                    // Sort rows based on clicked column (numeric or text comparison)
                    rows.sort((a, b) => {
                        let aText = a.children[index].textContent.trim();
                        let bText = b.children[index].textContent.trim();

                        if (numericCols.includes(index)) {
                            const aVal = parseFloat(aText.replace(',', '.')) || 0;
                            const bVal = parseFloat(bText.replace(',', '.')) || 0;
                            return (aVal - bVal) * (newDir === 'asc' ? 1 : -1);
                        } else {
                            return aText.localeCompare(bText) * (newDir === 'asc' ? 1 : -1);
                        }
                    });

                    // Re-attach sorted rows back to the table body
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        })();
    </script>
}
