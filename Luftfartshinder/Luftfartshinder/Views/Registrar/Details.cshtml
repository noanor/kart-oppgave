@using System.Globalization
@model Luftfartshinder.Models.ViewModel.EditReportRequest
@{
    ViewData["Title"] = "Registrar – Details";
}

@section Styles {
    <link href="~/css/registrar.css" rel="stylesheet" />
    <link href="~/css/draft.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
}
          


<div class="container">
    <!-- PERFECTLY CENTERED HEADER -->
    <div class="row align-items-center mb-4">
        <!-- Left: Back to list -->
        <div class="col-4 text-start">
            <a href="@Url.Action("Index", "Registrar")" class="back-icon">
                <i class="bi bi-arrow-left-circle"></i>
            </a>
        </div>

        <!-- Center: Obstacle title -->
        <div class="col-4 text-center">
            <h1 class="page-title mb-0">Report #@Model.Id</h1>
            <h2 class="figure-caption">Reported by: @Model.Author</h2>
        </div>

        <!-- Right: Delete button -->
        <div class="col-4 text-end">
            <button type="button"
                    class="btn btn-danger btn-sm d-inline-flex align-items-center gap-2"
                    data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="bi bi-trash"></i>
            </button>
        </div>

    </div>
</div>

<div class="container h-auto">
    @for (int i = 0; i < Model.Obstacles.Count; i++)
    {
            
    var o = Model.Obstacles.ToList()[i];
            
    <!-- META BOX (ID / Type / Status) -->
    <div class="card meta-box mb-2 mt-5 h-10">
        <div class="card-body">
            <div class="meta-grid">

                <!-- ID -->
                <div class="meta-item">
                    <div class="meta-label">ID</div>
                    <div class="meta-value">#@o.Id</div>
                </div>

                <!-- Type -->
                <div class="meta-item">
                    <div class="meta-label">Type</div>
                    <div class="meta-value">@o.Type</div>
                </div>

                <!-- Status -->
                <div class="meta-item">
                    <div class="meta-label">Status</div>

                    <div class="meta-actions">

                        @switch (o.Status)
                        {
                            case Luftfartshinder.Models.Domain.Obstacle.Statuses.Approved:
                                <span class="pill pill-approved">Approved</span>
                                break;

                            case Luftfartshinder.Models.Domain.Obstacle.Statuses.Rejected:
                                <span class="pill pill-rejected">Rejected</span>
                                break;

                            case Luftfartshinder.Models.Domain.Obstacle.Statuses.Pending:
                                <span class="pill pill-pending">Pending</span>
                                break;
                        }

                        <!-- Approve -->
                        <form asp-controller="Registrar" asp-action="Approve" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@o.Id" />
                            <button type="submit" class="btn btn-success btn-pill">Approve</button>
                        </form>

                        <!-- Reject -->
                        <form asp-controller="Registrar" asp-action="Reject" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@o.Id" />
                            <button type="submit" class="btn btn-danger btn-pill">Reject</button>
                        </form>

                    </div> 
                </div>

            </div>
        </div>
    </div>


    <div class="row mb-5 position-relative" style="height: 70vh;">

        <!-- LEFT COLUMN -->
        <div class="col-xl-6 h-100 position-absolute obstacle-column">
            <!-- Obstacle details -->
            <div class="card card-large shadow-sm mb-auto w-100 position-absolute h-60 left-col-card">
                <div class="card-header fw-semibold">General Information</div>
                <div class="card-body">
                    <dl class="info-grid mb-0">
                        <dt>Latitude</dt>
                        <dd>@o.Latitude.ToString("0.######")</dd>

                        <dt>Longitude</dt>
                        <dd>@o.Longitude.ToString("0.######")</dd>

                        <dt>Height</dt>
                        <dd>@((o.Height?.ToString()) ?? "-")</dd>

                        <dt>Description</dt>
                        <dd>@(!string.IsNullOrWhiteSpace(o.Description) ? o.Description : "-")</dd>
                    </dl>
                </div>
            </div>

            <!-- Registrar Note -->
            <div class="card card-large shadow-sm bottom-0 position-absolute w-100 h-40 left-col-card">
                <div class="card-header fw-semibold">Registrar Note</div>
                <div class="card-body">
                    <form id="registrarNoteForm" asp-controller="Registrar" asp-action="SaveNote" method="post" class="row g-3">
                        <input type="hidden" name="Id" value="@o.Id" />
                        @Html.AntiForgeryToken()

                        <div class="col-12">
                            <textarea name="RegistrarNote" class="form-control" rows="4"
                                        placeholder="Ask for more info, add internal remarks, etc."
                                          
                            >@o.RegistrarNote</textarea>
                        </div>

                    </form>
                        <div class="col-12 d-flex align-items-center gap-3 position-absolute btn-save-note">
                            <button class="btn btn-primary btn-sm px-4 py-2" data-bs-toggle="modal" data-bs-target="#modalSaveNote">
                                Save note
                            </button>
                        </div>
                </div>
            </div> 
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-xl-6 h-100 position-absolute end-0 obstacle-column">
            <div class="card card-large shadow-sm h-100 mb-0">
                <div class="card-header fw-semibold">Map Preview</div>
                <div class="card-body h-100">
                    <div class="obstacle-map h-100"
                            data-lat="@o.Latitude.ToString(CultureInfo.InvariantCulture)"
                            data-lng="@o.Longitude.ToString(CultureInfo.InvariantCulture)"
                            id="map-@i">
                    </div>

                </div>
            </div>
        </div>

    </div>
    <!-- Delete confirmation modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Delete obstacle?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete <strong>@Model.Title</strong>? This action cannot be undone!

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form asp-controller="Registrar" asp-action="Delete" method="post" class="d-inline">
                        <input type="hidden" name="id" value="@Model.Id" />
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <!-- Save note confirmation modal-->
    <div class="modal fade" id="modalSaveNote" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalSaveNote" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Submit Draft</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to submit note for obstacle #@o.Id?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                    @Html.AntiForgeryToken()
                    <button id="btnSubminDraft"
                            class="btn btn-primary"
                            type="submit"
                            form="registrarNoteForm">
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    }
<div class="toast-container position-fixed end-0 p-3" style="z-index: 3000; top: 5vh;">
    <div id="toastNoteSaved" class="toast text-white bg-success border-0 opacity-75" role="alert">
        <div class="toast-body">
            Note saved!
        </div>
    </div>
</div>


</div>
@section Scripts {
    <script src="~/js/draft.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const submitted = '@TempData["NoteSaved"]';
            if (submitted === 'True') {
                const toastEl = document.getElementById('toastNoteSaved');
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
            }
        });
    </script>
}

