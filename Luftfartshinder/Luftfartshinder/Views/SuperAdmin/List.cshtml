@model UserViewModel

@section Styles {
	<link rel="stylesheet" href="~/css/userlist.css" />
}

@* Success / Error toast messages shown at the top of the page *@
@if (TempData["Success"] != null)
{
	<div class="position-fixed top-0 start-50 translate-middle-x p-3 alert-toast-container">
		<div id="successAlert" class="alert alert-success alert-dismissible fade show shadow-lg border-0" role="alert">
			<div class="d-flex align-items-center">
				<div class="flex-shrink-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
						<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
					</svg>
				</div>
				<div class="flex-grow-1 ms-3">
					<strong>Success!</strong>
					<div class="small mt-1">@TempData["Success"]</div>
				</div>
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		</div>
	</div>
}
@if (TempData["Error"] != null)
{
	<div class="position-fixed top-0 start-50 translate-middle-x p-3 alert-toast-container">
		<div id="errorAlert" class="alert alert-danger alert-dismissible fade show shadow-lg border-0" role="alert">
			<div class="d-flex align-items-center">
				<div class="flex-shrink-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-circle-fill" viewBox="0 0 16 16">
						<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4m.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
					</svg>
				</div>
				<div class="flex-grow-1 ms-3">
					<strong>Error!</strong>
					<div class="small mt-1">@TempData["Error"]</div>
				</div>
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		</div>
	</div>
}

<div class="pt-5 mt-5 mb-5">
	<div class="container">
		<h1>List of Users</h1>
	</div>
</div>

<div>
	<div class="container">
		
		@* Navigation back to the main dashboard *@
		<div class="mb-3">
			<a asp-controller="Dashboard" asp-action="Dashboard" class="btn btn-secondary">
				&larr; Back to Dashboard
			</a>
		</div>

		@* Quick filter buttons for role and search / advanced filters *@
		<div class="d-flex justify-content-between align-items-center mb-4">
			@* Quick role buttons that reload the page with a new roleFilter *@
			<div class="btn-group" role="group" aria-label="Filter by role">
				<a href="@Url.Action("List", new { roleFilter = "All" })"
				class="btn @(ViewBag.CurrentFilter == "All" ? "btn-dark" : "btn-outline-dark")">
					All Users
				</a>
				<a href="@Url.Action("List", new { roleFilter = "Registrar" })"
				class="btn @(ViewBag.CurrentFilter == "Registrar" ? "btn-dark" : "btn-outline-dark")">
					Registrars
				</a>
				<a href="@Url.Action("List", new { roleFilter = "FlightCrew" })"
				class="btn @(ViewBag.CurrentFilter == "FlightCrew" ? "btn-dark" : "btn-outline-dark")">
					Flight Crew
				</a>
			</div>

			@* Simple client-side search box and toggle for advanced filters *@
			<div class="d-flex align-items-center">
				<input type="text" id="userSearch" class="form-control form-control-sm me-2" placeholder="Search users...">
        
				@*Advanced filters toggle*@
				<button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters" aria-expanded="false" aria-controls="advancedFilters">
					Advanced Filters
				</button>
			</div>
		</div>

		@* Advanced filter panel (Role, Status, Organization) *@
		<div class="collapse mb-4" id="advancedFilters">
			<div class="card card-body bg-light">
				<div class="row g-3">
					<div class="col-md-3">
						<label class="form-label">Role</label>
						<select id="filterRole" class="form-select">
							<option value="">All Roles</option>
							<option value="Registrar" selected="@(ViewBag.CurrentFilter == "Registrar")">Registrar</option>
							<option value="FlightCrew" selected="@(ViewBag.CurrentFilter == "FlightCrew")">Flight Crew</option>
						</select>
					</div>
					<div class="col-md-3">
						<label class="form-label">Status</label>
						<select id="filterStatus" class="form-select">
							<option value="">All Statuses</option>
							<option value="Approved" selected="@(ViewBag.StatusFilter == "Approved")">Approved</option>
							<option value="Pending" selected="@(ViewBag.StatusFilter == "Pending")">Pending</option>
						</select>
					</div>
					<div class="col-md-3">
						<label class="form-label">Organization</label>
						<select id="filterOrganization" class="form-select">
							<option value="">All Organizations</option>
							<option value="Norwegian Air Ambulance" selected="@(ViewBag.OrganizationFilter == "Norwegian Air Ambulance")">Norwegian Air Ambulance</option>
							<option value="Police" selected="@(ViewBag.OrganizationFilter == "Police")">Police</option>
							<option value="Norwegian Armed Forces" selected="@(ViewBag.OrganizationFilter == "Norwegian Armed Forces")">Norwegian Armed Forces</option>
							<option value="Avinor" selected="@(ViewBag.OrganizationFilter == "Avinor")">Avinor</option>
							<option value="Other" selected="@(ViewBag.OrganizationFilter == "Other")">Other</option>
						</select>
					</div>
					<div class="col-md-3 d-flex align-items-end">
						<button class="btn btn-primary" id="applyFilters">Apply Filters</button>
						<button class="btn btn-secondary ms-2" id="resetFilters">Reset</button>
					</div>
				</div>
			</div>
		</div>

		@* Main user table - only shown when there are users in the model *@
		@if (Model.Users != null && Model.Users.Any())
		{
			@* Container where active filter "chips" are rendered by JavaScript *@
			<div id="activeFilters" class="d-flex flex-wrap gap-2 mb-3"></div>
			
			<span id="userCount" data-total="@ViewBag.TotalUsers">Showing @Model.Users.Count() of @ViewBag.TotalUsers users</span>

			
			<table class="table table-hover">
				<thead>
				<tr>
					<th>Username</th>
					<th>Email</th>
					<th>Organization</th>
					<th>Role</th>
					<th>Status</th>
					<th>Actions</th>
				</tr>
				</thead>
				<tbody>
				@foreach (var user in Model.Users)
				{
					<tr>
						<td>@user.UserName</td>
						<td>@user.EmailAddress</td>
						<td>@(user.Organization?.Name ?? String.Empty)</td>
						<td>@user.Role</td>
						<td>
							@* Visual status indicator for each user *@
							@if (user.IsApproved)
							{
								<span class="badge bg-success">Approved</span>
							}
							else
							{
								<span class="badge bg-warning text-dark">Pending</span>
							}
						</td>
						<td>
							@* Action buttons for approve / decline / delete users *@
							@if (!user.IsApproved)
							{
								<form method="post" class="btn-inline"
								      asp-controller="SuperAdmin"
								      asp-action="Approve"
								      asp-route-id="@user.Id"
								      data-confirm="Are you sure you want to approve @user.UserName?"
								      data-action-type="approve">
									@Html.AntiForgeryToken()
									<input type="hidden" name="roleFilter" value="@ViewBag.CurrentFilter" />
									<input type="hidden" name="statusFilter" value="@ViewBag.StatusFilter" />
									<input type="hidden" name="organizationFilter" value="@ViewBag.OrganizationFilter" />
									<button class="btn btn-success btn-sm" type="submit">Approve</button>
								</form>
								<form method="post" class="btn-inline"
								      asp-controller="SuperAdmin"
								      asp-action="Decline"
								      asp-route-id="@user.Id"
								      data-confirm="Are you sure you want to decline @user.UserName? This will remove the user from the system."
								      data-action-type="decline">
									@Html.AntiForgeryToken()
									<input type="hidden" name="roleFilter" value="@ViewBag.CurrentFilter" />
									<input type="hidden" name="statusFilter" value="@ViewBag.StatusFilter" />
									<input type="hidden" name="organizationFilter" value="@ViewBag.OrganizationFilter" />
									<button class="btn btn-danger btn-sm" type="submit">Decline</button>
								</form>
							}
							else
							{
								<form method="post" class="btn-inline"
								      asp-controller="SuperAdmin"
								      asp-action="Delete"
								      asp-route-id="@user.Id"
								      data-confirm="Are you sure you want to delete @user.UserName?"
								      data-action-type="delete">
									@Html.AntiForgeryToken()
									<input type="hidden" name="roleFilter" value="@ViewBag.CurrentFilter" />
									<input type="hidden" name="statusFilter" value="@ViewBag.StatusFilter" />
									<input type="hidden" name="organizationFilter" value="@ViewBag.OrganizationFilter" />
									<button class="btn btn-danger btn-sm" type="submit">Delete</button>
								</form>
							}
						</td>
					</tr>
				}
				</tbody>
			</table>
		}
		else
		{
			@* Fallback message when there are no users to show *@
			<div class="alert alert-info" role="alert">
				<i class="bi bi-info-circle"></i>
				@if (!string.IsNullOrEmpty(ViewBag.NoUsersMessage))
				{
					@ViewBag.NoUsersMessage
				}
				else
				{
					<text>No users found.</text>
				}
			</div>

		}


	</div>
</div>

@* Reusable confirmation modal. *@
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header border-0">
				<h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="confirmModalBody">
				Are you sure you want to proceed?
			</div>
			<div class="modal-footer border-0">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" id="confirmModalBtn">Confirm</button>
			</div>
		</div>
	</div>
</div>



@section Scripts {
	<script src="~/js/list.js" asp-append-version="true"></script>
}
